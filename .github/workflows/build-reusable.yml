# .github/workflows/build-reusable.yml
name: Reusable C++ Build Workflow

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      ref:
        required: true
        type: string
    secrets:
      REPO_B_DISPATCH_TOKEN:
        required: true

env:
  FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}        
jobs:
  build:
    name: Build C++ on branch ${{ inputs.branch }}
    runs-on: self-hosted
    environment: dev

    steps:
      - name: Notify Start
        run: |
          curl -X POST $FEISHU_WEBHOOK -H "Content-Type: application/json" -d '{
            "msg_type": "text",
            "content": { "text": "ğŸš€ å¼€å§‹æ„å»ºæµç¨‹ï¼š${{ github.workflow }} by ${{ github.actor }}" }
          }'

      - name: Generate timestamp
        id: gen_time
        run: |
          echo "ts=$(date +'%Y%m%d_%H%M%S')" >> "$GITHUB_OUTPUT"
          echo "TIMESTAMP=$(date +%s)" >> $GITHUB_ENV
      - name: Checkout repository to dynamic path
        uses: actions/checkout@v4
        with:
          ref:  ${{ inputs.ref }}
          path: build-${{ steps.gen_time.outputs.ts }}      
      - name: Get commit info from checked out branch
        id: get_commit_info
        run: |
          REPO_NAME=$(basename "${{ github.repository }}")
          echo "repo_name=$REPO_NAME" >> "$GITHUB_OUTPUT"
          echo "hash=$(git -C build-${{ steps.gen_time.outputs.ts }} rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git -C build-${{ steps.gen_time.outputs.ts }} log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "tag=$(git -C build-${{ steps.gen_time.outputs.ts }} describe --tags --abbrev=0 --exact-match 2>/dev/null || echo 'no-tag')" >> $GITHUB_OUTPUT
          echo "time=$(git -C build-${{ steps.gen_time.outputs.ts }} log -1 --pretty=format:'%cI')" >> $GITHUB_OUTPUT
      - name: Notify Docker build start
        run: |
          curl -X POST $FEISHU_WEBHOOK -H "Content-Type: application/json" -d '{
            "msg_type": "text",
            "content": { "text": "ğŸ”§ å¼€å§‹æ„å»º Docker é•œåƒ..." }
          }'
      - name: Build inside Docker and output artifact
        run: |
          export SRC_DIR="${GITHUB_WORKSPACE}/build-${{ steps.gen_time.outputs.ts }}"
          export OUTPUT_DIR=${{ vars.OUTPUT_DIR }}/${{ steps.get_commit_info.outputs.repo_name }}/${{ inputs.branch }}
          mkdir -p ${OUTPUT_DIR}/csv
          export LIB_DIR=${{ vars.OUTPUT_DIR }}
          mkdir -p "${SRC_DIR}/build"        
          docker run --rm \
            -v "${SRC_DIR}:/workspace" \
            -v "${OUTPUT_DIR}:/output" \
            -v "${LIB_DIR}:/custom_lib" \
            -w	/workspace \
            --entrypoint bash davidwu-base-gcc:1.0  -c "
              cd build &&
              cmake -DCMAKE_CXX_FLAGS="-I/custom_lib" -DCMAKE_INSTALL_PREFIX=/output .. &&
              cmake --build . -- -j50 &&
              cmake --install . &&
              chmod -R 777 /output/* &&
              echo "key,value" > /output/csv/system.csv &&
              echo "os_version,$(source /etc/os-release && echo "${ID}:${VERSION_ID}")" >> /output/csv/system.csv &&
              echo "cmake_version,$(cmake --version | head -n1 | awk '{print $3}')" >> /output/csv/system.csv &&
              echo "gcc_version,$(g++ -dumpfullversion)" >> /output/csv/system.csv &&
              echo done"
      - name: Notify build completed
        run: |
          curl -X POST $FEISHU_WEBHOOK -H "Content-Type: application/json" -d '{
            "msg_type": "text",
            "content": { "text": "ğŸ‰ C++ ç¼–è¯‘æµç¨‹æˆåŠŸå®Œæˆ" }
          }'
      - name: Generate hash and build info CSV
        run: |
          export OUTPUT_DIR=${{ vars.OUTPUT_DIR }}/${{ steps.get_commit_info.outputs.repo_name }}/${{ inputs.branch }}
          HASH_FILE="${OUTPUT_DIR}/csv/hashes.csv"          
          BUILD_INFO_FILE="${OUTPUT_DIR}/csv/build_info.csv"
          {
            echo "key,value"
            echo "build_id,${{ steps.get_commit_info.outputs.repo_name }}_${{ inputs.branch }}_${{ env.TIMESTAMP }}"
            echo "repo_name,${{ steps.get_commit_info.outputs.repo_name }}"
            echo "repo,${{ github.repository }}"
            echo "commit_msg,${{ steps.get_commit_info.outputs.message }}"
            echo "commit_tag,${{ steps.get_commit_info.outputs.tag }}"
            echo "branch,${{ inputs.branch }}"
            echo "commit_hash,${{ steps.get_commit_info.outputs.hash }}"      
            echo "commit_time,${{ steps.get_commit_info.outputs.time }}"
            echo "actor,${{ github.actor }}"
            echo "event_name,${{ github.event_name }}" 
            echo "image_name,davidwu-base-gcc" 
            echo "image_hash,a2e1c068baa8" 
            echo "mount_path,${OUTPUT_DIR}"
            echo "output_path,${OUTPUT_DIR}"
          } > "$BUILD_INFO_FILE"
          echo "filename,sha256" > "$HASH_FILE"
          find "${OUTPUT_DIR}/bin" -type f -executable | while read file; do
            hash=$(sha256sum "$file" | awk '{print $1}')
            rel_path="${file#${OUTPUT_DIR}/}"
            echo "${rel_path},${hash}" >> "$HASH_FILE"
          done
          DEPEND_REPO_FILE="${OUTPUT_DIR}/csv/depen_repo.csv"
          {
            echo "key,value"
          } > "$DEPEND_REPO_FILE"
          echo "âœ… Hash CSV generated at: ${HASH_FILE}"
          cat "$HASH_FILE"
          echo "âœ… build info CSV generated at: ${BUILD_INFO_FILE}"
          cat "$BUILD_INFO_FILE"

      - name: Trigger Repo B repository_dispatch event
        uses: peter-evans/repository-dispatch@v2 # ä½¿ç”¨ä¸€ä¸ªç°æˆçš„ action æ¥å‘é€ dispatch äº‹ä»¶
        with: 
          token: ${{ secrets.REPO_B_DISPATCH_TOKEN }} 
          # æŒ‡å®šç›®æ ‡ä»“åº“ (æ ¼å¼: owner/repo_name)
          # å°† YOUR_REPO_B_OWNER å’Œ YOUR_REPO_B_NAME æ›¿æ¢ä¸ºä»“åº“ B çš„å®é™…æ‰€æœ‰è€…å’Œä»“åº“å
          repository: Darrenzzy/arrow
          # å®šä¹‰ä¸€ä¸ªäº‹ä»¶ç±»å‹ï¼Œä»“åº“ B å¯ä»¥æ ¹æ®è¿™ä¸ªç±»å‹æ¥è¿‡æ»¤
          event-type: triggered-by-repo-a-update
          # (å¯é€‰) å‘é€ä¸€ä¸ª payloadï¼Œå¯ä»¥åœ¨ä»“åº“ B çš„ workflow ä¸­è®¿é—®è¿™äº›ä¿¡æ¯
          # ä¾‹å¦‚ï¼Œå¯ä»¥å‘é€ä»“åº“ A çš„ commit SHA æˆ–åˆ†æ”¯ä¿¡æ¯
          client-payload: |
            {
              "ref": "${{ inputs.branch }}",
              "full_ref": "${{ inputs.ref }}",
              "sha": "${{ github.sha }}",
              "repo_name": "${{ steps.get_commit_info.outputs.repo_name }}",
              "triggered_by_repo": "${{ github.repository }}"
            }
      - name: Clean up work directory
        run: |
          export SRC_DIR="${GITHUB_WORKSPACE}/build-${{ steps.gen_time.outputs.ts }}"
          echo "${SRC_DIR}/build"  # æ¸…ç†å·¥ä½œç›®å½•
          # rm -rf ${SRC_DIR}/build/*  # æ¸…ç†å·¥ä½œç›®å½•
# ğŸ”š é€šçŸ¥æ„å»ºç»“æŸï¼ˆæˆåŠŸï¼‰
      - name: Notify All Done
        if: success()
        run: |
          curl -X POST $FEISHU_WEBHOOK -H "Content-Type: application/json" -d '{
            "msg_type": "text",
            "content": { "text": "ğŸ“¦ æ‰€æœ‰æ­¥éª¤å®Œæˆï¼Œæ„å»ºäº§ç‰©å·²ä¸Šä¼ ã€‚" }
          }'

      # âŒ å¦‚æœå¤±è´¥åˆ™å‘é€é£ä¹¦é€šçŸ¥
      - name: Notify failure
        if: failure()
        run: |
          curl -X POST $FEISHU_WEBHOOK -H "Content-Type: application/json" -d '{
            "msg_type": "text",
            "content": { "text": "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ã€‚" }
          }'